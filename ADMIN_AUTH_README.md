# Admin Authentication System

This document describes the secure admin login flow implemented for Porch Records using Next.js App Router.

## Features

- **Username/Password Authentication**: Hardcoded credentials stored in environment variables
- **Two-Factor Authentication (2FA)**: Optional TOTP support using Google Authenticator or similar apps
- **Session Management**: JWT-based sessions with secure HTTP-only cookies
- **Route Protection**: Middleware automatically redirects unauthenticated users
- **Logout Functionality**: Secure session termination

## Pages

- `/admin/login` - Username/password login form
- `/admin/2fa` - TOTP verification (if 2FA is enabled)
- `/admin/2fa-setup` - 2FA management interface (enable/disable, generate secrets, test setup)
- `/admin/*` - Protected admin routes (automatically redirects to login if not authenticated)

## Setup Instructions

### 1. Environment Variables

Create or update your `.env.local` file with the following variables:

```bash
# Required: Admin credentials
ADMIN_USERNAME=your_admin_username
ADMIN_PASSWORD=your_secure_password

# Required: JWT secret (change this to a secure random string)
JWT_SECRET=your-super-secret-jwt-key-change-this

# Optional: TOTP secret for 2FA (leave empty to disable 2FA)
TOTP_SECRET=your_totp_secret_here
```

### 2. Generate TOTP Secret (Optional)

You have two options to generate a TOTP secret:

**Option A: Command Line**
```bash
node scripts/generate-totp-secret.js
```

**Option B: Admin Interface (Recommended)**
1. Log into the admin panel
2. Navigate to "Security" → "2FA Setup"
3. Click "Enable 2FA" to generate a new secret
4. Follow the on-screen instructions to set up your authenticator app

Both methods will:
- Generate a secure TOTP secret
- Display a QR code you can scan with your authenticator app
- Show the secret in Base32 format to add to your `.env.local`

### 3. Setup Authenticator App

1. Install an authenticator app (Google Authenticator, Authy, Microsoft Authenticator, etc.)
2. Scan the QR code generated by the script, or manually enter the secret
3. The app will generate 6-digit codes that change every 30 seconds

## How It Works

### Authentication Flow

1. **Login**: User enters username/password at `/admin/login`
2. **Credential Verification**: System checks against environment variables
3. **2FA Check**: If `TOTP_SECRET` is set, user is redirected to `/admin/2fa`
4. **TOTP Verification**: User enters 6-digit code from authenticator app
5. **Session Creation**: JWT token is created and stored in HTTP-only cookie
6. **Access Granted**: User can access protected admin routes

### Security Features

- **HTTP-Only Cookies**: JWT tokens are stored in secure, HTTP-only cookies
- **Environment Variables**: All secrets are stored in environment variables, not in code
- **Middleware Protection**: All `/admin/*` routes are automatically protected
- **Session Expiration**: JWT tokens expire after 24 hours
- **Secure Redirects**: Proper redirect handling prevents open redirects

### File Structure

```
src/
├── app/
│   ├── admin/
│   │   ├── login/
│   │   │   └── page.tsx          # Login form
│   │   ├── 2fa/
│   │   │   └── page.tsx          # 2FA verification
│   │   └── page.tsx              # Protected admin dashboard
│   └── api/
│       └── admin/
│           └── auth/
│               ├── login/
│               │   └── route.ts  # Login API
│               ├── 2fa/
│               │   └── route.ts  # 2FA API
│               └── logout/
│                   └── route.ts  # Logout API
├── lib/
│   └── auth.ts                   # Authentication utilities
├── middleware.ts                 # Route protection middleware
└── components/
    └── AdminLayout.tsx           # Admin layout with logout button
```

## Usage

### Default Credentials

If no environment variables are set, the system uses these defaults:
- Username: `admin`
- Password: `admin123`
- 2FA: Disabled

**⚠️ Important**: Change these defaults in production!

### Testing the System

1. Start the development server: `npm run dev`
2. Navigate to `http://localhost:3000/admin`
3. You'll be redirected to `/admin/login`
4. Enter your credentials
5. If 2FA is enabled, you'll be redirected to `/admin/2fa`
6. Enter the code from your authenticator app
7. You'll be redirected to the admin dashboard

### Managing 2FA

**Enabling 2FA:**
1. Log into the admin panel
2. Navigate to "Security" → "2FA Setup"
3. Click "Enable 2FA" to generate a new secret
4. Copy the generated secret to your `.env.local` file
5. Restart your development server

**Disabling 2FA:**
1. Log into the admin panel
2. Navigate to "Security" → "2FA Setup"
3. Click "Disable 2FA"
4. Remove the `TOTP_SECRET` line from your `.env.local` file
5. Restart your development server

**Testing 2FA:**
- Use the "Test 2FA" button in the 2FA Setup page to verify your authenticator app is working correctly
- This helps ensure your setup is working before you're locked out of the admin panel

### Logout

Users can logout by clicking the "Logout" button in the admin sidebar. This will:
1. Clear the session cookie
2. Redirect to the login page

## Security Considerations

1. **Change Default Credentials**: Always set custom `ADMIN_USERNAME` and `ADMIN_PASSWORD`
2. **Use Strong JWT Secret**: Generate a secure random string for `JWT_SECRET`
3. **Environment Variables**: Never commit `.env.local` to version control
4. **HTTPS in Production**: Ensure your production environment uses HTTPS
5. **Regular Secret Rotation**: Consider rotating TOTP secrets periodically
6. **Monitor Access**: Consider adding logging for admin access attempts

## Troubleshooting

### Common Issues

1. **"Invalid username or password"**
   - Check that `ADMIN_USERNAME` and `ADMIN_PASSWORD` are set correctly
   - Ensure no extra spaces in environment variables

2. **"Invalid 2FA code"**
   - Ensure your device's clock is synchronized
   - Check that the TOTP secret is correct
   - Try entering the code quickly (they expire after 30 seconds)

3. **Redirect loops**
   - Clear browser cookies
   - Check that middleware is working correctly
   - Verify environment variables are loaded

4. **Session not persisting**
   - Check that cookies are enabled in your browser
   - Verify `JWT_SECRET` is set
   - Check for HTTPS issues in production

### Debug Mode

To enable debug logging, add this to your `.env.local`:

```bash
DEBUG_AUTH=true
```

This will log authentication attempts and session information to the console.

## API Endpoints

### POST /api/admin/auth/login
- **Body**: `{ username: string, password: string }`
- **Response**: `{ success: boolean, requires2FA: boolean, message: string }`

### POST /api/admin/auth/2fa
- **Body**: `{ code: string }`
- **Response**: `{ success: boolean, message: string }`

### POST /api/admin/auth/logout
- **Body**: None
- **Response**: `{ success: boolean, message: string }`

### GET /api/admin/auth/2fa-status
- **Body**: None
- **Response**: `{ enabled: boolean, secret?: string, qrCodeUrl?: string }`

### POST /api/admin/auth/generate-totp
- **Body**: None
- **Response**: `{ enabled: boolean, secret: string, qrCodeUrl: string, message: string, envVariable: string }`

### POST /api/admin/auth/test-2fa
- **Body**: `{ code: string }`
- **Response**: `{ success: boolean, message: string }`

### POST /api/admin/auth/disable-2fa
- **Body**: None
- **Response**: `{ enabled: boolean, message: string, instructions: string[] }`

## Dependencies

- `speakeasy` - TOTP generation and verification
- `qrcode` - QR code generation for TOTP setup
- `jsonwebtoken` - JWT token handling
- `bcryptjs` - Password hashing (if needed for future enhancements) 